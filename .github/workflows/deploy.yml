name: Deploy

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Lint and format
        run: |
          uv run ruff format .
          uv run ruff check . --fix

      - name: Run unit tests
        run: uv run pytest -m unit

      - name: Deploy all stacks
        run: uv run cdk deploy --all --require-approval never --outputs-file cdk-outputs.json

      - name: Update dev endpoints
        run: |
          for stack in ServerlessDeepAgentStack ResearchAgentStack CodingAgentStack; do
            RUNTIME_ID=$(cat cdk-outputs.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('$stack', {}).get('RuntimeId', ''))" 2>/dev/null || echo "")
            if [ -n "$RUNTIME_ID" ]; then
              VERSION=$(uv run python scripts/get_latest_version.py $RUNTIME_ID 2>/dev/null || echo "")
              if [ -n "$VERSION" ]; then
                echo "Updating $stack dev endpoint to version $VERSION"
                aws bedrock-agentcore-control update-agent-runtime-endpoint \
                  --agent-runtime-id $RUNTIME_ID \
                  --endpoint-name dev \
                  --agent-runtime-version $VERSION \
                  --region ${{ env.AWS_REGION }} || true
              fi
            fi
          done

      - name: Run E2E tests
        run: |
          ARN=$(cat cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin)['ServerlessDeepAgentStack']['RuntimeArn'])")
          AGENT_RUNTIME_ARN=$ARN AGENT_ENDPOINT=dev uv run pytest -m e2e

      - name: Promote DeepAgent to canary
        run: |
          RUNTIME_ID=$(cat cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin)['ServerlessDeepAgentStack']['RuntimeId'])")
          VERSION=$(uv run python scripts/get_latest_version.py $RUNTIME_ID)
          aws bedrock-agentcore-control update-agent-runtime-endpoint \
            --agent-runtime-id $RUNTIME_ID \
            --endpoint-name canary \
            --agent-runtime-version $VERSION \
            --region ${{ env.AWS_REGION }}

      - name: Promote DeepAgent to prod
        run: |
          RUNTIME_ID=$(cat cdk-outputs.json | python3 -c "import sys,json; print(json.load(sys.stdin)['ServerlessDeepAgentStack']['RuntimeId'])")
          VERSION=$(uv run python scripts/get_latest_version.py $RUNTIME_ID)
          aws bedrock-agentcore-control update-agent-runtime-endpoint \
            --agent-runtime-id $RUNTIME_ID \
            --endpoint-name prod \
            --agent-runtime-version $VERSION \
            --region ${{ env.AWS_REGION }}

